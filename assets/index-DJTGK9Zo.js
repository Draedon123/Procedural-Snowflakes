(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class P{buffer;dataview;littleEndian;offset;constructor(e,t=!0,i=0){this.buffer=new ArrayBuffer(e),this.dataview=new DataView(this.buffer),this.littleEndian=t,this.offset=i}writeFloat32(e){this.dataview.setFloat32(this.offset,e,this.littleEndian),this.offset+=4}writeUint32(e){this.dataview.setUint32(this.offset,e,this.littleEndian),this.offset+=4}pad(e){this.offset+=e}}class E{samples;maxSamples;constructor(e){this.samples=[],this.maxSamples=e}get average(){return this.samples.reduce((e,t)=>e+t,0)/this.samples.length}addSample(e){this.samples.length===this.maxSamples&&this.samples.shift(),this.samples.push(e)}reset(){this.samples.splice(0,this.samples.length)}}class h{static linkedTimers={};canTimestamp;querySet;resolveBuffer;resultBuffer;rollingAverage;onUpdate;constructor(e,t=()=>{},i=null){this.canTimestamp=e.features.has("timestamp-query"),this.onUpdate=t,this.rollingAverage=new E(50),this.canTimestamp&&(this.querySet=e.createQuerySet({label:"GPUTimer Query Set",type:"timestamp",count:2}),this.resolveBuffer=e.createBuffer({label:"GPUTimer Resolve Buffer",size:this.querySet.count*8,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=e.createBuffer({label:"GPUTimer Result Buffer",size:this.resolveBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}));const s=e.queue.submit.bind(e.queue);e.queue.submit=n=>{s(n),this.canTimestamp&&e.queue.onSubmittedWorkDone().then(()=>{this.resultBuffer.mapState==="unmapped"&&this.resultBuffer.mapAsync(GPUMapMode.READ).then(()=>{const a=new BigInt64Array(this.resultBuffer.getMappedRange());this.rollingAverage.addSample(Number(a[1]-a[0])),this.resultBuffer.unmap();const o=this.rollingAverage.average,l=i===null?o:h.linkedTimers[i].reduce((u,f)=>u+f.time,0);this.onUpdate(o,l)})})},i!==null&&(i in h.linkedTimers||(h.linkedTimers[i]=[]),h.linkedTimers[i].push(this))}get time(){return this.rollingAverage.average}beginPass(e,t,i){const s={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1},a=e[t==="render"?"beginRenderPass":"beginComputePass"].bind(e)({...i,...this.canTimestamp?{timestampWrites:s}:void 0}),o=a.end.bind(a);return a.end=()=>{o(),this.canTimestamp&&(e.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),this.resultBuffer.mapState==="unmapped"&&e.copyBufferToBuffer(this.resolveBuffer,this.resultBuffer))},a}beginComputePass(e,t={}){return this.beginPass(e,"compute",t)}beginRenderPass(e,t){return this.beginPass(e,"render",t)}reset(){this.rollingAverage.reset()}}function m(r){return`/Procedural-Snowflakes/${r}`}function S(r){return r+16-r%16}class c{shader;constructor(e,t,i){this.shader=e.createShaderModule({label:i,code:t})}static async fetch(e,t,i){const s=await(await fetch(t)).text(),n=await c.preprocess(t,s);return new c(e,n,i)}static async preprocess(e,t){return c.resolveImports(e,t)}static async resolveImports(e,t,i=[]){const s=/#!import.*\s/g,n=e.split("/"),a=n.slice(0,n.length-1).join("/")+"/",o=t.match(s)?.map(u=>u.replaceAll(/(#!import)|\s/g,"")).filter(u=>!i.includes(u)).map(u=>a+u+".wgsl")??[];return((await Promise.all(o.map(async u=>{const f=await(await fetch(u)).text();return c.resolveImports(u,f,i)}))).join("")+t).replaceAll(s,"")}}class T{path;shader;device;gpuTimer;constructor(e){this.path=e}get initialised(){return this.shader!==void 0}async initialise(e){this.initialised||(this.device=e,this.gpuTimer=new h(e,void 0,1),this.shader=await c.fetch(e,this.path))}run(){if(!this.initialised)return;const e=this.device.createCommandEncoder(),t=this.gpuTimer.beginComputePass(e);t.setBindGroup(0,this.bindGroup),t.setPipeline(this.computePipeline),t.dispatchWorkgroups(...this.workgroupSize),t.end(),this.device.queue.submit([e.finish()])}}class y extends T{static SETTINGS_BYTE_LENGTH=S(4);bindGroup;computePipeline;renderer;settingsBuffer;bindGroupLayout;renderTexture;constructor(e){super(m("shaders/renderCells.wgsl")),this.renderer=e}async initialise(e){if(this.initialised)return;await super.initialise(e),this.settingsBuffer=e.createBuffer({label:"Render Cells Shader Settings Buffer",size:y.SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.bindGroupLayout=e.createBindGroupLayout({label:"Render Cells Shader Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:2,storageTexture:{access:"write-only",format:"rgba8unorm"},visibility:GPUShaderStage.COMPUTE}]});const t=e.createPipelineLayout({label:"Render Cells Shader Compute Pipeline Layout",bindGroupLayouts:[this.bindGroupLayout]});this.updateRenderTextureAndBindGroups(),this.computePipeline=e.createComputePipeline({label:"Render Cells Shader Compute Pipeline",layout:t,compute:{module:this.shader.shader,entryPoint:"main"}})}get workgroupSize(){return[Math.ceil(this.renderer.canvas.width/8),Math.ceil(this.renderer.canvas.height/8),1]}updateRenderTextureAndBindGroups(){this.renderTexture?.destroy(),this.renderTexture=this.createRenderTexture(),this.bindGroup=this.device.createBindGroup({label:"Render Cells Shader Bind Group",layout:this.bindGroupLayout,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:{buffer:this.renderer.snowflake.buffer}},{binding:2,resource:this.renderTexture.createView()}]})}createRenderTexture(){return this.device.createTexture({label:"Render Texture",format:"rgba8unorm",size:[this.renderer.canvas.width,this.renderer.canvas.height],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT})}}class C extends T{bindGroup;computePipeline;renderer;constructor(e){super(m("shaders/stage1.wgsl")),this.renderer=e}async initialise(e){if(this.initialised)return;await super.initialise(e);const t=e.createBindGroupLayout({label:"Stage 1 Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE}]}),i=e.createPipelineLayout({label:"Stage 1 Shader Compute Pipeline Layout",bindGroupLayouts:[t]});this.bindGroup=e.createBindGroup({label:"Stage 1 Shader Bind Group",layout:t,entries:[{binding:0,resource:{buffer:this.renderer.snowflake.buffer}}]}),this.computePipeline=e.createComputePipeline({label:"Stage 1 Shader Compute Pipeline",layout:i,compute:{module:this.shader.shader,entryPoint:"main"}})}get workgroupSize(){return[Math.ceil(2*this.renderer.snowflake.radius/8),Math.ceil(2*this.renderer.snowflake.radius/8),1]}}function b(r,e,t){return Math.min(Math.max(r,e),t)}class B extends T{static SETTINGS_BYTE_LENGTH=S(12);bindGroup;computePipeline;renderer;settingsBuffer;_alpha;_beta;_gamma;constructor(e){super(m("shaders/stage2.wgsl")),this.renderer=e,this.alpha=1,this.beta=.7,this.gamma=.001}async initialise(e){if(this.initialised)return;await super.initialise(e),this.settingsBuffer=e.createBuffer({label:"Stage 2 Shader Settings Buffer",size:B.SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const t=e.createBindGroupLayout({label:"Stage 2 Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE}]}),i=e.createPipelineLayout({label:"Stage 2 Shader Compute Pipeline Layout",bindGroupLayouts:[t]});this.bindGroup=e.createBindGroup({label:"Stage 2 Shader Bind Group",layout:t,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:{buffer:this.renderer.snowflake.buffer}}]}),this.computePipeline=e.createComputePipeline({label:"Stage 2 Shader Compute Pipeline",layout:i,compute:{module:this.shader.shader,entryPoint:"main"}})}get workgroupSize(){return[Math.ceil(2*this.renderer.snowflake.radius/8)+1,Math.ceil(2*this.renderer.snowflake.radius/8)+1,1]}updateSettings(){this.initialised&&this.device.queue.writeBuffer(this.settingsBuffer,0,new Float32Array([this.alpha,this.beta,this.gamma]))}get alpha(){return this._alpha}get beta(){return this._beta}get gamma(){return this._gamma}set alpha(e){this._alpha=e,this.updateSettings(),this.renderer.snowflake.reset()}set beta(e){this._beta=b(e,0,1),this.renderer.snowflake.backgroundLevel=this.beta,this.updateSettings(),this.renderer.snowflake.reset()}set gamma(e){this._gamma=b(e,0,1),this.updateSettings(),this.renderer.snowflake.reset()}}class d{static MAX_RADIUS=256;static CELL_BYTE_LENGTH=12;static BYTE_LENGTH=8+4*d.MAX_RADIUS*d.MAX_RADIUS*d.CELL_BYTE_LENGTH;state;_radius;_backgroundLevel;device;buffer;constructor(e){this.radius=e,this.backgroundLevel=0,this.state=0}initialise(e){return this.initialised?this:(this.device=e,this.buffer=e.createBuffer({label:"Snowflake Buffer",size:d.BYTE_LENGTH,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.update(),this)}update(){if(!this.initialised)return;const e=new P(d.BYTE_LENGTH);e.writeUint32(this.radius),e.writeUint32(this.state);for(let t=0;t<4*this.radius*this.radius;t++){const i=t%(2*this.radius)-this.radius,s=Math.floor(t/(2*this.radius))-this.radius,n=i===0&&s===0?1:this.backgroundLevel;e.writeFloat32(n),e.writeFloat32(n),e.writeUint32(0)}this.device.queue.writeBuffer(this.buffer,0,e.buffer)}reset(){this.update()}get initialised(){return this.buffer!==void 0}nextState(){this.state=this.state===0?1:0,this.initialised&&this.device.queue.writeBuffer(this.buffer,4,new Uint32Array([this.state]))}get radius(){return this._radius}set radius(e){this._radius=b(e,1,d.MAX_RADIUS),this.update()}get backgroundLevel(){return this._backgroundLevel}set backgroundLevel(e){this._backgroundLevel=e,this.update()}}class p{static RENDER_SETTINGS_BYTE_LENGTH=S(1*Float32Array.BYTES_PER_ELEMENT);canvas;settings;snowflake;computeShaders;device;ctx;canvasFormat;gpuTimer;initialised;renderSettingsBuffer;renderBindGroupLayout;renderBindGroup;renderPipeline;sampler;constructor(e,t,i){const s=e.getContext("webgpu");if(s===null)throw new Error("Could not create WebGPU Canvas Context");this.canvas=e,this.device=i,this.ctx=s,this.canvasFormat="rgba8unorm",this.snowflake=new d(50).initialise(this.device),this.computeShaders={renderCells:new y(this),stage1:new C(this),stage2:new B(this)},this.gpuTimer=new h(this.device,(n,a)=>{const o=a/1e3,l=a/1e6,u=a/1e9,f=l>1,w=(f?l:o).toFixed(2),G=f?"ms":"Î¼s";if(this.settings.timing?.frameTimeElement!==void 0&&(this.settings.timing.frameTimeElement.textContent=w+G),this.settings.timing?.fpsElement!==void 0){const v=1/u;this.settings.timing.fpsElement.textContent=v.toFixed(2)}},1),this.initialised=!1,this.settings={timing:t.timing}}serialiseRenderSettings(){return new P(p.RENDER_SETTINGS_BYTE_LENGTH).buffer}createRenderBindGroup(){return this.device.createBindGroup({label:"Renderer Bind Group",layout:this.renderBindGroupLayout,entries:[{binding:0,resource:{buffer:this.renderSettingsBuffer}},{binding:1,resource:this.computeShaders.renderCells.renderTexture.createView()},{binding:2,resource:this.sampler}]})}async initialise(){this.initialised||(await this.computeShaders.renderCells.initialise(this.device),await this.computeShaders.stage1.initialise(this.device),await this.computeShaders.stage2.initialise(this.device),await this.initialiseRendering(),this.updateSettings(),new ResizeObserver(e=>{const t=e[0],i=t.devicePixelContentBoxSize[0].inlineSize,s=t.devicePixelContentBoxSize[0].blockSize;this.canvas.width=i,this.canvas.height=s,this.gpuTimer.reset(),this.computeShaders.renderCells.updateRenderTextureAndBindGroups(),this.renderBindGroup=this.createRenderBindGroup(),this.computeShaders.renderCells.run(),this.renderToCanvas()}).observe(this.canvas),this.initialised=!0)}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat}),this.renderSettingsBuffer=this.device.createBuffer({label:"Render Settings Buffer",size:p.RENDER_SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.sampler=this.device.createSampler({label:"Renderer Texture Sampler",minFilter:"linear",magFilter:"linear"});const e=await c.fetch(this.device,m("shaders/renderTexture.wgsl"));this.renderBindGroupLayout=this.device.createBindGroupLayout({label:"Renderer Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,texture:{},visibility:GPUShaderStage.FRAGMENT},{binding:2,sampler:{},visibility:GPUShaderStage.FRAGMENT}]}),this.renderBindGroup=this.createRenderBindGroup();const t=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[this.renderBindGroupLayout]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:t,vertex:{module:e.shader,entryPoint:"vertexMain"},fragment:{module:e.shader,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]}})}updateSettings(){this.device.queue.writeBuffer(this.renderSettingsBuffer,0,this.serialiseRenderSettings())}render(){this.computeShaders.stage1.run(),this.computeShaders.stage2.run(),this.snowflake.nextState(),this.computeShaders.renderCells.run(),this.renderToCanvas()}renderToCanvas(){const e=this.device.createCommandEncoder(),t=this.gpuTimer.beginRenderPass(e,{colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}]});t.setBindGroup(0,this.renderBindGroup),t.setPipeline(this.renderPipeline),t.draw(3),t.end(),this.device.queue.submit([e.finish()])}static async create(e,t={}){if(!("gpu"in navigator))throw new Error("WebGPU not supported");const i=await navigator.gpu.requestAdapter();if(i===null)throw new Error("Could not find suitable GPU Adapter");const s=await i.requestDevice({requiredFeatures:["timestamp-query"]});if(s===null)throw new Error("Could not find suitable GPU Device");return new p(e,t,s)}}class L{settings;callbacks=[];frameID;lastFrameTime;totalTime;constructor(e={}){this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.callbacks=[],this.settings={wormholeThreshold:e.wormholeThreshold??500}}start(){this.running||(this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}restart(){this.running&&this.stop(),this.start()}addCallback(e){this.callbacks.push(e)}tick(e){this.lastFrameTime<0&&(this.lastFrameTime=e);const t=e-this.lastFrameTime,i=this.totalTime+t;if(t<this.settings.wormholeThreshold){const s={deltaTime:t,totalTime:i};for(const n of this.callbacks)n(s);this.totalTime=i}this.lastFrameTime=e,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return this.frameID!==null}}function U(r){R(),g("alpha",{decimalPlaces:2,onChange:e=>r.computeShaders.stage2.alpha=e}),g("beta",{decimalPlaces:2,onChange:e=>r.computeShaders.stage2.beta=e}),g("gamma",{decimalPlaces:3,onChange:e=>r.computeShaders.stage2.gamma=e})}function R(){const r=document.getElementById("chevron"),e=document.getElementById("content");if(r===null)throw new Error("Could not find chevron element");if(e===null)throw new Error("Could not find info panel");r.addEventListener("click",()=>{r.classList.toggle("collapsed"),e.classList.toggle("collapsed")})}function g(r,e={}){const t=`${r}Input`,i=`${r}Value`,s=document.getElementById(t),n=document.getElementById(i);if(s===null)throw new Error(`Could not find slider with id ${t}`);if(n===null)throw new Error(`Could not find value display with id ${n}`);s.addEventListener("change",()=>{const a=e.processValue??(u=>u),o="processText"in e&&e.processText!==void 0?e.processText:"decimalPlaces"in e?u=>`(${u.toFixed(e.decimalPlaces)})`:u=>`(${u.toString()})`,l=a(parseFloat(s.value));n.textContent=o(l),e.onChange?.(l)})}async function x(){const r=document.getElementById("main"),e=document.getElementById("frameTime"),t=document.getElementById("fps"),i=await p.create(r,{timing:{frameTimeElement:e,fpsElement:t}});await i.initialise(),i.snowflake.radius=200;const s=new L;U(i),s.addCallback(()=>{i.render()}),s.start()}x().catch(r=>{const e=r instanceof Error?r.message:JSON.stringify(r),t=document.getElementById("alert");t!==null&&(t.style.zIndex="999",t.classList.add("error"),t.textContent=e),console.error(e)});

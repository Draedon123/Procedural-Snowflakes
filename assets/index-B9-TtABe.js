(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();class P{buffer;dataview;littleEndian;offset;constructor(e,t=!0,s=0){this.buffer=new ArrayBuffer(e),this.dataview=new DataView(this.buffer),this.littleEndian=t,this.offset=s}writeFloat32(e){this.dataview.setFloat32(this.offset,e,this.littleEndian),this.offset+=4}writeUint32(e){this.dataview.setUint32(this.offset,e,this.littleEndian),this.offset+=4}pad(e){this.offset+=e}}class v{samples;maxSamples;constructor(e){this.samples=[],this.maxSamples=e}get average(){return this.samples.reduce((e,t)=>e+t,0)/this.samples.length}addSample(e){this.samples.length===this.maxSamples&&this.samples.shift(),this.samples.push(e)}reset(){this.samples.splice(0,this.samples.length)}}class c{static linkedTimers={};canTimestamp;querySet;resolveBuffer;resultBuffer;rollingAverage;onUpdate;constructor(e,t=()=>{},s=null){this.canTimestamp=e.features.has("timestamp-query"),this.onUpdate=t,this.rollingAverage=new v(50),this.canTimestamp&&(this.querySet=e.createQuerySet({label:"GPUTimer Query Set",type:"timestamp",count:2}),this.resolveBuffer=e.createBuffer({label:"GPUTimer Resolve Buffer",size:this.querySet.count*8,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=e.createBuffer({label:"GPUTimer Result Buffer",size:this.resolveBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}));const i=e.queue.submit.bind(e.queue);e.queue.submit=r=>{i(r),this.canTimestamp&&e.queue.onSubmittedWorkDone().then(()=>{this.resultBuffer.mapState==="unmapped"&&this.resultBuffer.mapAsync(GPUMapMode.READ).then(()=>{const a=new BigInt64Array(this.resultBuffer.getMappedRange());this.rollingAverage.addSample(Number(a[1]-a[0])),this.resultBuffer.unmap();const o=this.rollingAverage.average,h=s===null?o:c.linkedTimers[s].reduce((u,l)=>u+l.time,0);this.onUpdate(o,h)})})},s!==null&&(s in c.linkedTimers||(c.linkedTimers[s]=[]),c.linkedTimers[s].push(this))}get time(){return this.rollingAverage.average}beginPass(e,t,s){const i={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1},a=e[t==="render"?"beginRenderPass":"beginComputePass"].bind(e)({...s,...this.canTimestamp?{timestampWrites:i}:void 0}),o=a.end.bind(a);return a.end=()=>{o(),this.canTimestamp&&(e.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),this.resultBuffer.mapState==="unmapped"&&e.copyBufferToBuffer(this.resolveBuffer,this.resultBuffer))},a}beginComputePass(e,t={}){return this.beginPass(e,"compute",t)}beginRenderPass(e,t){return this.beginPass(e,"render",t)}reset(){this.rollingAverage.reset()}}function g(n){return`/Procedural-Snowflakes/${n}`}function y(n){return n+16-n%16}class f{shader;constructor(e,t,s){this.shader=e.createShaderModule({label:s,code:t})}static async fetch(e,t,s){const i=await(await fetch(t)).text(),r=await f.preprocess(t,i);return new f(e,r,s)}static async preprocess(e,t){return f.resolveImports(e,t)}static async resolveImports(e,t,s=[]){const i=/#!import.*\s/g,r=e.split("/"),a=r.slice(0,r.length-1).join("/")+"/",o=t.match(i)?.map(u=>u.replaceAll(/(#!import)|\s/g,"")).filter(u=>!s.includes(u)).map(u=>a+u+".wgsl")??[];return((await Promise.all(o.map(async u=>{const l=await(await fetch(u)).text();return f.resolveImports(u,l,s)}))).join("")+t).replaceAll(i,"")}}class S{path;shader;device;gpuTimer;constructor(e){this.path=e}get initialised(){return this.shader!==void 0}async initialise(e){this.initialised||(this.device=e,this.gpuTimer=new c(e,void 0,1),this.shader=await f.fetch(e,this.path))}run(){if(!this.initialised)return;const e=this.device.createCommandEncoder(),t=this.gpuTimer.beginComputePass(e);t.setBindGroup(0,this.bindGroup),t.setPipeline(this.computePipeline),t.dispatchWorkgroups(...this.workgroupSize),t.end(),this.device.queue.submit([e.finish()])}}class U extends S{bindGroup;computePipeline;renderer;constructor(e){super(g("shaders/postRender.wgsl")),this.renderer=e}async initialise(e){if(this.initialised)return;await super.initialise(e);const t=e.createBindGroupLayout({label:"Post Render Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE}]}),s=e.createPipelineLayout({label:"Post Render Shader Compute Pipeline Layout",bindGroupLayouts:[t]});this.bindGroup=e.createBindGroup({label:"Post Render Shader Bind Group",layout:t,entries:[{binding:0,resource:{buffer:this.renderer.computeShaders.stage2.finishedBuffer}},{binding:1,resource:{buffer:this.renderer.computeShaders.renderCells.settingsBuffer}}]}),this.computePipeline=e.createComputePipeline({label:"Post Render Shader Compute Pipeline",layout:s,compute:{module:this.shader.shader,entryPoint:"main"}})}get workgroupSize(){return[1,1,1]}}class B extends S{static SETTINGS_BYTE_LENGTH=y(4);bindGroup;computePipeline;renderer;settingsBuffer;bindGroupLayout;renderTexture;constructor(e){super(g("shaders/renderCells.wgsl")),this.renderer=e}async initialise(e){if(this.initialised)return;await super.initialise(e),this.settingsBuffer=e.createBuffer({label:"Render Cells Shader Settings Buffer",size:B.SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.bindGroupLayout=e.createBindGroupLayout({label:"Render Cells Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:2,storageTexture:{access:"write-only",format:"rgba8unorm"},visibility:GPUShaderStage.COMPUTE}]});const t=e.createPipelineLayout({label:"Render Cells Shader Compute Pipeline Layout",bindGroupLayouts:[this.bindGroupLayout]});this.updateRenderTextureAndBindGroups(),this.computePipeline=e.createComputePipeline({label:"Render Cells Shader Compute Pipeline",layout:t,compute:{module:this.shader.shader,entryPoint:"main"}})}get workgroupSize(){return[Math.ceil(this.renderer.canvas.width/8),Math.ceil(this.renderer.canvas.height/8),1]}updateRenderTextureAndBindGroups(){this.renderTexture?.destroy(),this.renderTexture=this.createRenderTexture(),this.bindGroup=this.device.createBindGroup({label:"Render Cells Shader Bind Group",layout:this.bindGroupLayout,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:{buffer:this.renderer.snowflake.buffer}},{binding:2,resource:this.renderTexture.createView()}]})}createRenderTexture(){return this.device.createTexture({label:"Render Texture",format:"rgba8unorm",size:[this.renderer.canvas.width,this.renderer.canvas.height],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT})}}class C extends S{bindGroup;computePipeline;renderer;constructor(e){super(g("shaders/stage1.wgsl")),this.renderer=e}async initialise(e){if(this.initialised)return;await super.initialise(e);const t=e.createBindGroupLayout({label:"Stage 1 Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE}]}),s=e.createPipelineLayout({label:"Stage 1 Shader Compute Pipeline Layout",bindGroupLayouts:[t]});this.bindGroup=e.createBindGroup({label:"Stage 1 Shader Bind Group",layout:t,entries:[{binding:0,resource:{buffer:this.renderer.snowflake.buffer}}]}),this.computePipeline=e.createComputePipeline({label:"Stage 1 Shader Compute Pipeline",layout:s,compute:{module:this.shader.shader,entryPoint:"main"}})}get workgroupSize(){return[Math.ceil(2*this.renderer.snowflake.radius/8)+1,Math.ceil(2*this.renderer.snowflake.radius/8)+1,1]}}function T(n,e,t){return Math.min(Math.max(n,e),t)}class b extends S{static SETTINGS_BYTE_LENGTH=y(12);static FINISHED_BUFFER_BYTE_LENGTH=4;bindGroup;computePipeline;renderer;settingsBuffer;finishedBuffer;_alpha;_beta;_gamma;constructor(e){super(g("shaders/stage2.wgsl")),this.renderer=e,this.alpha=1,this.beta=.6,this.gamma=.01}async initialise(e){if(this.initialised)return;await super.initialise(e),this.settingsBuffer=e.createBuffer({label:"Stage 2 Shader Settings Buffer",size:b.SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.finishedBuffer=e.createBuffer({label:"Stage 2 Shader Finished Buffer",size:b.FINISHED_BUFFER_BYTE_LENGTH,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});const t=e.createBindGroupLayout({label:"Stage 2 Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:2,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:3,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE}]}),s=e.createPipelineLayout({label:"Stage 2 Shader Compute Pipeline Layout",bindGroupLayouts:[t]});this.bindGroup=e.createBindGroup({label:"Stage 2 Shader Bind Group",layout:t,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:{buffer:this.renderer.snowflake.buffer}},{binding:2,resource:{buffer:this.renderer.computeShaders.renderCells.settingsBuffer}},{binding:3,resource:{buffer:this.finishedBuffer}}]}),this.computePipeline=e.createComputePipeline({label:"Stage 2 Shader Compute Pipeline",layout:s,compute:{module:this.shader.shader,entryPoint:"main"}}),this.updateSettings()}get workgroupSize(){return[Math.ceil(2*this.renderer.snowflake.radius/8)+1,Math.ceil(2*this.renderer.snowflake.radius/8)+1,1]}reset(){this.device.queue.writeBuffer(this.finishedBuffer,0,new Uint32Array(0))}updateSettings(){this.initialised&&this.device.queue.writeBuffer(this.settingsBuffer,0,new Float32Array([this.alpha,this.beta,this.gamma]))}get alpha(){return this._alpha}get beta(){return this._beta}get gamma(){return this._gamma}set alpha(e){this._alpha=e,this.updateSettings(),this.renderer.snowflake.reset()}set beta(e){this._beta=T(e,0,1),this.renderer.snowflake.backgroundLevel=this.beta,this.updateSettings(),this.renderer.snowflake.reset()}set gamma(e){this._gamma=T(e,0,1),this.updateSettings(),this.renderer.snowflake.reset()}}class d{static MAX_RADIUS=256;static CELL_BYTE_LENGTH=20;static BYTE_LENGTH=8+4*d.MAX_RADIUS*d.MAX_RADIUS*d.CELL_BYTE_LENGTH;state;_radius;_backgroundLevel;device;buffer;constructor(e){this.radius=e,this.backgroundLevel=0,this.state=0}initialise(e){return this.initialised?this:(this.device=e,this.buffer=e.createBuffer({label:"Snowflake Buffer",size:d.BYTE_LENGTH,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.update(),this)}update(){if(!this.initialised)return;const e=new P(d.BYTE_LENGTH);e.writeUint32(this.radius),e.writeUint32(this.state);for(let t=0;t<4*this.radius*this.radius;t++){const s=t%(2*this.radius)-this.radius,i=Math.floor(t/(2*this.radius))-this.radius,r=s===0&&i===0?1:this.backgroundLevel;e.writeFloat32(r),e.writeFloat32(r),e.writeFloat32(0),e.writeFloat32(0),e.writeUint32(0)}this.device.queue.writeBuffer(this.buffer,0,e.buffer)}reset(){this.update()}get initialised(){return this.buffer!==void 0}nextState(){this.state=this.state===0?1:0,this.initialised&&this.device.queue.writeBuffer(this.buffer,4,new Uint32Array([this.state]))}get radius(){return this._radius}set radius(e){this._radius=T(e,1,d.MAX_RADIUS),this.update()}get backgroundLevel(){return this._backgroundLevel}set backgroundLevel(e){this._backgroundLevel=e,this.update()}}class p{static RENDER_SETTINGS_BYTE_LENGTH=y(1*Float32Array.BYTES_PER_ELEMENT);canvas;settings;snowflake;computeShaders;device;ctx;canvasFormat;gpuTimer;initialised;renderSettingsBuffer;renderBindGroupLayout;renderBindGroup;renderPipeline;sampler;constructor(e,t,s){const i=e.getContext("webgpu");if(i===null)throw new Error("Could not create WebGPU Canvas Context");this.canvas=e,this.device=s,this.ctx=i,this.canvasFormat="rgba8unorm",this.snowflake=new d(50).initialise(this.device),this.computeShaders={postRender:new U(this),renderCells:new B(this),stage1:new C(this),stage2:new b(this)},this.gpuTimer=new c(this.device,(r,a)=>{const o=a/1e3,h=a/1e6,u=a/1e9,l=h>1,G=(l?h:o).toFixed(2),w=l?"ms":"Î¼s";if(this.settings.timing?.frameTimeElement!==void 0&&(this.settings.timing.frameTimeElement.textContent=G+w),this.settings.timing?.fpsElement!==void 0){const E=1/u;this.settings.timing.fpsElement.textContent=E.toFixed(2)}},1),this.initialised=!1,this.settings={timing:t.timing,speed:t.speed??1}}serialiseRenderSettings(){return new P(p.RENDER_SETTINGS_BYTE_LENGTH).buffer}createRenderBindGroup(){return this.device.createBindGroup({label:"Renderer Bind Group",layout:this.renderBindGroupLayout,entries:[{binding:0,resource:{buffer:this.renderSettingsBuffer}},{binding:1,resource:this.computeShaders.renderCells.renderTexture.createView()},{binding:2,resource:this.sampler}]})}async initialise(){this.initialised||(await this.computeShaders.renderCells.initialise(this.device),await this.computeShaders.stage1.initialise(this.device),await this.computeShaders.stage2.initialise(this.device),await this.computeShaders.postRender.initialise(this.device),await this.initialiseRendering(),this.updateSettings(),new ResizeObserver(e=>{const t=e[0],s=t.devicePixelContentBoxSize[0].inlineSize,i=t.devicePixelContentBoxSize[0].blockSize;this.canvas.width=s,this.canvas.height=i,this.gpuTimer.reset(),this.computeShaders.renderCells.updateRenderTextureAndBindGroups(),this.renderBindGroup=this.createRenderBindGroup(),this.computeShaders.renderCells.run(),this.renderToCanvas()}).observe(this.canvas),this.initialised=!0)}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat}),this.renderSettingsBuffer=this.device.createBuffer({label:"Render Settings Buffer",size:p.RENDER_SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.sampler=this.device.createSampler({label:"Renderer Texture Sampler",minFilter:"linear",magFilter:"linear"});const e=await f.fetch(this.device,g("shaders/renderTexture.wgsl"));this.renderBindGroupLayout=this.device.createBindGroupLayout({label:"Renderer Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,texture:{},visibility:GPUShaderStage.FRAGMENT},{binding:2,sampler:{},visibility:GPUShaderStage.FRAGMENT}]}),this.renderBindGroup=this.createRenderBindGroup();const t=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[this.renderBindGroupLayout]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:t,vertex:{module:e.shader,entryPoint:"vertexMain"},fragment:{module:e.shader,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]}})}updateSettings(){this.device.queue.writeBuffer(this.renderSettingsBuffer,0,this.serialiseRenderSettings())}render(){for(let e=0;e<this.settings.speed;e++)this.computeShaders.stage1.run(),this.computeShaders.stage2.run(),this.snowflake.nextState();this.computeShaders.renderCells.run(),this.computeShaders.postRender.run(),this.renderToCanvas()}renderToCanvas(){const e=this.device.createCommandEncoder(),t=this.gpuTimer.beginRenderPass(e,{colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}]});t.setBindGroup(0,this.renderBindGroup),t.setPipeline(this.renderPipeline),t.draw(3),t.end(),this.device.queue.submit([e.finish()])}static async create(e,t={}){if(!("gpu"in navigator))throw new Error("WebGPU not supported");const s=await navigator.gpu.requestAdapter();if(s===null)throw new Error("Could not find suitable GPU Adapter");const i=await s.requestDevice({requiredFeatures:["timestamp-query"]});if(i===null)throw new Error("Could not find suitable GPU Device");return new p(e,t,i)}}class L{settings;callbacks=[];frameID;lastFrameTime;totalTime;constructor(e={}){this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.callbacks=[],this.settings={wormholeThreshold:e.wormholeThreshold??500}}start(){this.running||(this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}restart(){this.running&&this.stop(),this.start()}addCallback(e){this.callbacks.push(e)}tick(e){this.lastFrameTime<0&&(this.lastFrameTime=e);const t=e-this.lastFrameTime,s=this.totalTime+t;if(t<this.settings.wormholeThreshold){const i={deltaTime:t,totalTime:s};for(const r of this.callbacks)r(i);this.totalTime=s}this.lastFrameTime=e,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return this.frameID!==null}}function R(n){x(),m("alpha",{decimalPlaces:2,onChange:t=>n.computeShaders.stage2.alpha=t}),m("beta",{decimalPlaces:2,onChange:t=>n.computeShaders.stage2.beta=t});function e(t){return-2.59216*t**5+3.51994*t**4+-.38784*t**3+.386606*t**2+.0735023*t}m("gamma",{decimalPlaces:4,onChange:t=>n.computeShaders.stage2.gamma=t,processValue:e,initialise:t=>{const s=parseFloat(t.value);let i=s,r=e(i),a=0,o=1;for(;Math.abs(s-r)>=1e-4;)r>s?o=i:a=i,i=(o+a)/2,r=e(i);t.value=i.toString()}}),m("speed",{processText:t=>`(${t}x)`,onChange:t=>n.settings.speed=t})}function x(){const n=document.getElementById("chevron"),e=document.getElementById("content");if(n===null)throw new Error("Could not find chevron element");if(e===null)throw new Error("Could not find info panel");n.addEventListener("click",()=>{n.classList.toggle("collapsed"),e.classList.toggle("collapsed")})}function m(n,e={}){const t=`${n}Input`,s=`${n}Value`,i=document.getElementById(t),r=document.getElementById(s);if(i===null)throw new Error(`Could not find slider with id ${t}`);if(r===null)throw new Error(`Could not find value display with id ${r}`);(e.initialise??(()=>{}))(i),i.addEventListener("change",()=>{const o=e.processValue??(l=>l),h="processText"in e&&e.processText!==void 0?e.processText:"decimalPlaces"in e?l=>`(${l.toFixed(e.decimalPlaces)})`:l=>`(${l.toString()})`,u=o(parseFloat(i.value));r.textContent=h(u),e.onChange?.(u)})}async function A(){const n=document.getElementById("main"),e=document.getElementById("frameTime"),t=document.getElementById("fps"),s=await p.create(n,{timing:{frameTimeElement:e,fpsElement:t}});await s.initialise(),s.snowflake.radius=200;const i=new L;R(s),i.addCallback(()=>{s.render()}),i.start()}A().catch(n=>{const e=n instanceof Error?n.message:JSON.stringify(n),t=document.getElementById("alert");t!==null&&(t.style.zIndex="999",t.classList.add("error"),t.textContent=e),console.error(e)});

(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();class E{samples;maxSamples;constructor(e){this.samples=[],this.maxSamples=e}get average(){return this.samples.reduce((e,t)=>e+t,0)/this.samples.length}addSample(e){this.samples.length===this.maxSamples&&this.samples.shift(),this.samples.push(e)}reset(){this.samples.splice(0,this.samples.length)}}class c{static linkedTimers={};canTimestamp;querySet;resolveBuffer;resultBuffer;rollingAverage;onUpdate;constructor(e,t=()=>{},i=null){this.canTimestamp=e.features.has("timestamp-query"),this.onUpdate=t,this.rollingAverage=new E(50),this.canTimestamp&&(this.querySet=e.createQuerySet({label:"GPUTimer Query Set",type:"timestamp",count:2}),this.resolveBuffer=e.createBuffer({label:"GPUTimer Resolve Buffer",size:this.querySet.count*8,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=e.createBuffer({label:"GPUTimer Result Buffer",size:this.resolveBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}));const s=e.queue.submit.bind(e.queue);e.queue.submit=r=>{s(r),this.canTimestamp&&e.queue.onSubmittedWorkDone().then(()=>{this.resultBuffer.mapState==="unmapped"&&this.resultBuffer.mapAsync(GPUMapMode.READ).then(()=>{const n=new BigInt64Array(this.resultBuffer.getMappedRange());this.rollingAverage.addSample(Number(n[1]-n[0])),this.resultBuffer.unmap();const u=this.rollingAverage.average,d=i===null?u:c.linkedTimers[i].reduce((o,l)=>o+l.time,0);this.onUpdate(u,d)})})},i!==null&&(i in c.linkedTimers||(c.linkedTimers[i]=[]),c.linkedTimers[i].push(this))}get time(){return this.rollingAverage.average}beginPass(e,t,i){const s={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1},n=e[t==="render"?"beginRenderPass":"beginComputePass"].bind(e)({...i,...this.canTimestamp?{timestampWrites:s}:void 0}),u=n.end.bind(n);return n.end=()=>{u(),this.canTimestamp&&(e.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),this.resultBuffer.mapState==="unmapped"&&e.copyBufferToBuffer(this.resolveBuffer,this.resultBuffer))},n}beginComputePass(e,t={}){return this.beginPass(e,"compute",t)}beginRenderPass(e,t){return this.beginPass(e,"render",t)}reset(){this.rollingAverage.reset()}}class v{settings;callbacks=[];frameID;lastFrameTime;totalTime;constructor(e={}){this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.callbacks=[],this.settings={wormholeThreshold:e.wormholeThreshold??500}}start(){this.running||(this.totalTime=0,this.lastFrameTime=-1,this.callbacks.forEach(e=>{e.type==="onStart"&&e.callback()}),this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}restart(){this.running&&this.stop(),this.start()}addCallback(e){this.callbacks.push(e)}tick(e){this.lastFrameTime<0&&(this.lastFrameTime=e);const t=e-this.lastFrameTime,i=this.totalTime+t;if(t<this.settings.wormholeThreshold){const s={deltaTime:t,totalTime:i};this.callbacks.forEach(r=>{r.type==="onTick"&&r.callback(s)}),this.totalTime=i}this.lastFrameTime=e,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return this.frameID!==null}}function f(a){return`/Procedural-Snowflakes/${a}`}class p{shader;constructor(e,t,i){this.shader=e.createShaderModule({label:i,code:t})}static async fetch(e,t,i){const s=await(await fetch(t)).text(),r=await p.preprocess(t,s);return new p(e,r,i)}static async preprocess(e,t){return p.resolveImports(e,t)}static async resolveImports(e,t,i=[]){const s=/#!import.*\s/g,r=e.split("/"),n=r.slice(0,r.length-1).join("/")+"/",u=t.match(s)?.map(o=>o.replaceAll(/(#!import)|\s/g,"")).filter(o=>!i.includes(o)).map(o=>n+o+".wgsl")??[];return((await Promise.all(u.map(async o=>{const l=await(await fetch(o)).text();return p.resolveImports(o,l,i)}))).join("")+t).replaceAll(s,"")}}class y{path;shader;device;gpuTimer;constructor(e){this.path=e}get initialised(){return this.shader!==void 0}async initialise(e){this.initialised||(this.device=e,this.gpuTimer=new c(e,void 0,1),this.shader=await p.fetch(e,this.path))}run(){if(!this.initialised)return;const e=this.device.createCommandEncoder(),t=this.gpuTimer.beginComputePass(e);t.setBindGroup(0,this.bindGroup),t.setPipeline(this.computePipeline),t.dispatchWorkgroups(...this.workgroupSize),t.end(),this.device.queue.submit([e.finish()])}}class C extends y{bindGroup;computePipeline;renderer;constructor(e){super(f("shaders/postRender.wgsl")),this.renderer=e}async initialise(e){if(this.initialised)return;await super.initialise(e);const t=e.createBindGroupLayout({label:"Post Render Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE}]}),i=e.createPipelineLayout({label:"Post Render Shader Compute Pipeline Layout",bindGroupLayouts:[t]});this.bindGroup=e.createBindGroup({label:"Post Render Shader Bind Group",layout:t,entries:[{binding:0,resource:{buffer:this.renderer.computeShaders.stage2.finishedBuffer}},{binding:1,resource:{buffer:this.renderer.computeShaders.renderCells.settingsBuffer}}]}),this.computePipeline=e.createComputePipeline({label:"Post Render Shader Compute Pipeline",layout:i,compute:{module:this.shader.shader,entryPoint:"main"}})}get workgroupSize(){return[1,1,1]}}function w(a){return a+16-a%16}class P extends y{static SETTINGS_BYTE_LENGTH=w(4);bindGroup;computePipeline;renderer;settingsBuffer;bindGroupLayout;renderTexture;constructor(e){super(f("shaders/renderCells.wgsl")),this.renderer=e}async initialise(e){if(this.initialised)return;await super.initialise(e),this.settingsBuffer=e.createBuffer({label:"Render Cells Shader Settings Buffer",size:P.SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.bindGroupLayout=e.createBindGroupLayout({label:"Render Cells Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:2,storageTexture:{access:"write-only",format:"rgba8unorm"},visibility:GPUShaderStage.COMPUTE}]});const t=e.createPipelineLayout({label:"Render Cells Shader Compute Pipeline Layout",bindGroupLayouts:[this.bindGroupLayout]});this.updateRenderTextureAndBindGroups(),this.computePipeline=e.createComputePipeline({label:"Render Cells Shader Compute Pipeline",layout:t,compute:{module:this.shader.shader,entryPoint:"main"}})}get workgroupSize(){return[Math.ceil(this.renderer.canvas.width/8),Math.ceil(this.renderer.canvas.height/8),1]}updateRenderTextureAndBindGroups(){this.renderTexture?.destroy(),this.renderTexture=this.createRenderTexture(),this.bindGroup=this.device.createBindGroup({label:"Render Cells Shader Bind Group",layout:this.bindGroupLayout,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:{buffer:this.renderer.snowflake.buffer}},{binding:2,resource:this.renderTexture.createView()}]})}createRenderTexture(){return this.device.createTexture({label:"Render Texture",format:"rgba8unorm",size:[this.renderer.canvas.width,this.renderer.canvas.height],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT})}}class U extends y{bindGroup;computePipeline;renderer;constructor(e){super(f("shaders/stage1.wgsl")),this.renderer=e}async initialise(e){if(this.initialised)return;await super.initialise(e);const t=e.createBindGroupLayout({label:"Stage 1 Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE}]}),i=e.createPipelineLayout({label:"Stage 1 Shader Compute Pipeline Layout",bindGroupLayouts:[t]});this.bindGroup=e.createBindGroup({label:"Stage 1 Shader Bind Group",layout:t,entries:[{binding:0,resource:{buffer:this.renderer.snowflake.buffer}}]}),this.computePipeline=e.createComputePipeline({label:"Stage 1 Shader Compute Pipeline",layout:i,compute:{module:this.shader.shader,entryPoint:"main"}})}get workgroupSize(){return[Math.ceil((2*this.renderer.snowflake.radius+1)/8),Math.ceil((2*this.renderer.snowflake.radius+1)/8),1]}}function B(a,e,t){return Math.min(Math.max(a,e),t)}class b extends y{static SETTINGS_BYTE_LENGTH=w(12);static FINISHED_BUFFER_BYTE_LENGTH=4;bindGroup;computePipeline;renderer;settingsBuffer;finishedBuffer;_alpha;_beta;_gamma;constructor(e){super(f("shaders/stage2.wgsl")),this.renderer=e,this.alpha=1.592,this.beta=.3,this.gamma=.001}async initialise(e){if(this.initialised)return;await super.initialise(e),this.settingsBuffer=e.createBuffer({label:"Stage 2 Shader Settings Buffer",size:b.SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.finishedBuffer=e.createBuffer({label:"Stage 2 Shader Finished Buffer",size:b.FINISHED_BUFFER_BYTE_LENGTH,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});const t=e.createBindGroupLayout({label:"Stage 2 Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:2,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:3,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE}]}),i=e.createPipelineLayout({label:"Stage 2 Shader Compute Pipeline Layout",bindGroupLayouts:[t]});this.bindGroup=e.createBindGroup({label:"Stage 2 Shader Bind Group",layout:t,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:{buffer:this.renderer.snowflake.buffer}},{binding:2,resource:{buffer:this.renderer.computeShaders.renderCells.settingsBuffer}},{binding:3,resource:{buffer:this.finishedBuffer}}]}),this.computePipeline=e.createComputePipeline({label:"Stage 2 Shader Compute Pipeline",layout:i,compute:{module:this.shader.shader,entryPoint:"main"}})}get workgroupSize(){return[Math.ceil(2*(this.renderer.snowflake.radius+1)/8),Math.ceil(2*(this.renderer.snowflake.radius+1)/8),1]}reset(){this.initialised&&this.device.queue.writeBuffer(this.finishedBuffer,0,new Uint32Array([0]))}updateSettings(){this.initialised&&this.device.queue.writeBuffer(this.settingsBuffer,0,new Float32Array([this.alpha,this.beta,this.gamma]))}get alpha(){return this._alpha}get beta(){return this._beta}get gamma(){return this._gamma}set alpha(e){this._alpha=Math.max(e,0),this.update()}set beta(e){this._beta=B(e,0,1),this.update()}set gamma(e){this._gamma=B(e,0,1),this.update()}update(){this.updateSettings(),this.reset(),this.renderer.snowflake.update(this.beta)}}class L{buffer;dataview;littleEndian;offset;constructor(e,t=!0,i=0){this.buffer=new ArrayBuffer(e),this.dataview=new DataView(this.buffer),this.littleEndian=t,this.offset=i}writeFloat32(e){this.dataview.setFloat32(this.offset,e,this.littleEndian),this.offset+=4}writeUint32(e){this.dataview.setUint32(this.offset,e,this.littleEndian),this.offset+=4}pad(e){this.offset+=e}}class h{static MAX_RADIUS=256;static CELL_BYTE_LENGTH=20;static BYTE_LENGTH=8+4*h.MAX_RADIUS*h.MAX_RADIUS*h.CELL_BYTE_LENGTH;radius;buffer;state;device;constructor(e){this.radius=e,this.state=0}initialise(e){return this.initialised?this:(this.device=e,this.buffer=e.createBuffer({label:"Snowflake Buffer",size:h.BYTE_LENGTH,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this)}update(e){if(!this.initialised)return;const t=new L(h.BYTE_LENGTH);t.writeUint32(this.radius),t.writeUint32(this.state);const i=4*(this.radius+1)*(this.radius+1);for(let s=0;s<i;s++){const r=s%(2*this.radius)-this.radius,n=Math.floor(s/(2*this.radius))-this.radius,u=Math.max(Math.abs(r),Math.abs(n),Math.abs(-r-n)),d=r===0&&n===0,o=u===1;if(!(u<=this.radius)){t.pad(h.CELL_BYTE_LENGTH);continue}const m=d?1:e,S=d||o?1:0;t.writeFloat32(m),t.writeFloat32(m),t.writeFloat32(0),t.writeFloat32(0),t.writeUint32(S)}this.device.queue.writeBuffer(this.buffer,0,t.buffer)}get initialised(){return this.buffer!==void 0}nextState(){this.state=this.state===0?1:0,this.initialised&&this.device.queue.writeBuffer(this.buffer,4,new Uint32Array([this.state]))}}class T{canvas;settings;snowflake;loop;computeShaders;device;ctx;canvasFormat;gpuTimer;initialised;renderBindGroupLayout;renderBindGroup;renderPipeline;sampler;constructor(e,t,i){const s=e.getContext("webgpu");if(s===null)throw new Error("Could not create WebGPU Canvas Context");this.canvas=e,this.device=i,this.ctx=s,this.canvasFormat="rgba8unorm",this.loop=new v,this.snowflake=new h(50).initialise(this.device),this.computeShaders={postRender:new C(this),renderCells:new P(this),stage1:new U(this),stage2:new b(this)},this.gpuTimer=new c(this.device,(r,n)=>{const u=n/1e3,d=n/1e6,o=n/1e9,l=d>1,m=(l?d:u).toFixed(2),S=l?"ms":"Î¼s";if(this.settings.timing?.frameTimeElement!==void 0&&(this.settings.timing.frameTimeElement.textContent=m+S),this.settings.timing?.fpsElement!==void 0){const G=1/o;this.settings.timing.fpsElement.textContent=G.toFixed(2)}},1),this.initialised=!1,this.settings={timing:t.timing,speed:t.speed??1}}createRenderBindGroup(){return this.device.createBindGroup({label:"Renderer Bind Group",layout:this.renderBindGroupLayout,entries:[{binding:0,resource:this.computeShaders.renderCells.renderTexture.createView()},{binding:1,resource:this.sampler}]})}async initialise(){this.initialised||(await this.computeShaders.renderCells.initialise(this.device),await this.computeShaders.stage1.initialise(this.device),await this.computeShaders.stage2.initialise(this.device),await this.computeShaders.postRender.initialise(this.device),this.computeShaders.stage2.update(),await this.initialiseRendering(),this.loop.addCallback({type:"onTick",callback:()=>{this.render()}}),new ResizeObserver(e=>{const t=e[0],i=t.devicePixelContentBoxSize[0].inlineSize,s=t.devicePixelContentBoxSize[0].blockSize;this.canvas.width=i,this.canvas.height=s,this.gpuTimer.reset(),this.computeShaders.renderCells.updateRenderTextureAndBindGroups(),this.renderBindGroup=this.createRenderBindGroup(),this.computeShaders.renderCells.run(),this.renderToCanvas()}).observe(this.canvas),this.initialised=!0)}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat}),this.sampler=this.device.createSampler({label:"Renderer Texture Sampler",minFilter:"linear",magFilter:"linear"});const e=await p.fetch(this.device,f("shaders/renderTexture.wgsl"));this.renderBindGroupLayout=this.device.createBindGroupLayout({label:"Renderer Bind Group Layout",entries:[{binding:0,texture:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,sampler:{},visibility:GPUShaderStage.FRAGMENT}]}),this.renderBindGroup=this.createRenderBindGroup();const t=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[this.renderBindGroupLayout]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:t,vertex:{module:e.shader,entryPoint:"vertexMain"},fragment:{module:e.shader,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]}})}render(){for(let e=0;e<this.settings.speed;e++)this.computeShaders.stage1.run(),this.computeShaders.stage2.run(),this.snowflake.nextState();this.computeShaders.renderCells.run(),this.computeShaders.postRender.run(),this.renderToCanvas()}renderToCanvas(){const e=this.device.createCommandEncoder(),t=this.gpuTimer.beginRenderPass(e,{colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}]});t.setBindGroup(0,this.renderBindGroup),t.setPipeline(this.renderPipeline),t.draw(3),t.end(),this.device.queue.submit([e.finish()])}static async create(e,t={}){if(!("gpu"in navigator))throw new Error("WebGPU not supported");const i=await navigator.gpu.requestAdapter();if(i===null)throw new Error("Could not find suitable GPU Adapter");const s=await i.requestDevice({requiredFeatures:["timestamp-query"]});if(s===null)throw new Error("Could not find suitable GPU Device");return new T(e,t,s)}}function x(a){R(),g("alpha",{decimalPlaces:3,onChange:t=>a.computeShaders.stage2.alpha=t}),g("beta",{decimalPlaces:2,onChange:t=>a.computeShaders.stage2.beta=t});function e(t){return-2.59216*t**5+3.51994*t**4+-.38784*t**3+.386606*t**2+.0735023*t}g("gamma",{decimalPlaces:4,onChange:t=>a.computeShaders.stage2.gamma=t,processValue:e,initialise:t=>{const i=parseFloat(t.value);let s=i,r=e(s),n=0,u=1;for(;Math.abs(i-r)>=1e-4;)r>i?u=s:n=s,s=(u+n)/2,r=e(s);t.value=s.toString()}}),g("speed",{processText:t=>`(${t}x)`,onChange:t=>a.settings.speed=t})}function R(){const a=document.getElementById("chevron"),e=document.getElementById("content");if(a===null)throw new Error("Could not find chevron element");if(e===null)throw new Error("Could not find info panel");a.addEventListener("click",()=>{a.classList.toggle("collapsed"),e.classList.toggle("collapsed")})}function g(a,e={}){const t=`${a}Input`,i=`${a}Value`,s=document.getElementById(t),r=document.getElementById(i);if(s===null)throw new Error(`Could not find slider with id ${t}`);if(r===null)throw new Error(`Could not find value display with id ${r}`);(e.initialise??(()=>{}))(s),s.addEventListener("change",()=>{const u=e.processValue??(l=>l),d="processText"in e&&e.processText!==void 0?e.processText:"decimalPlaces"in e?l=>`(${l.toFixed(e.decimalPlaces)})`:l=>`(${l.toString()})`,o=u(parseFloat(s.value));r.textContent=d(o),e.onChange?.(o)})}async function M(){const a=document.getElementById("main"),e=document.getElementById("frameTime"),t=document.getElementById("fps"),i=await T.create(a,{speed:5,timing:{frameTimeElement:e,fpsElement:t}});await i.initialise(),i.snowflake.radius=200,i.snowflake.update(i.computeShaders.stage2.beta),x(i),i.loop.start()}M().catch(a=>{const e=a instanceof Error?a.message:JSON.stringify(a),t=document.getElementById("alert"),i=document.getElementById("error"),s=document.getElementById("fallback");t.style.zIndex="999",i.classList.add("error"),i.textContent=e,s.src="https://www.youtube.com/embed/hyhJWh_Vt0w",s.classList.remove("hidden"),console.error(e)});

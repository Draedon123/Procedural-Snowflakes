(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();class m{buffer;dataview;littleEndian;offset;constructor(e,t=!0,s=0){this.buffer=new ArrayBuffer(e),this.dataview=new DataView(this.buffer),this.littleEndian=t,this.offset=s}writeFloat32(e){this.dataview.setFloat32(this.offset,e,this.littleEndian),this.offset+=4}writeUint32(e){this.dataview.setUint32(this.offset,e,this.littleEndian),this.offset+=4}pad(e){this.offset+=e}}class v{samples;maxSamples;constructor(e){this.samples=[],this.maxSamples=e}get average(){return this.samples.reduce((e,t)=>e+t,0)/this.samples.length}addSample(e){this.samples.length===this.maxSamples&&this.samples.shift(),this.samples.push(e)}reset(){this.samples.splice(0,this.samples.length)}}class d{static modifiedDevices=new Set;canTimestamp;querySet;resolveBuffer;resultBuffer;rollingAverage;onUpdate;constructor(e,t=()=>{}){if(this.canTimestamp=e.features.has("timestamp-query"),this.onUpdate=t,this.rollingAverage=new v(50),this.canTimestamp&&(this.querySet=e.createQuerySet({label:"GPUTimer Query Set",type:"timestamp",count:2}),this.resolveBuffer=e.createBuffer({label:"GPUTimer Resolve Buffer",size:this.querySet.count*BigInt64Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=e.createBuffer({label:"GPUTimer Result Buffer",size:this.resolveBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),!d.modifiedDevices.has(e)){const s=e.queue.submit.bind(e.queue);e.queue.submit=i=>{s(i),!(!this.canTimestamp||this.resultBuffer.mapState!=="unmapped")&&this.resultBuffer.mapAsync(GPUMapMode.READ).then(()=>{const r=new BigInt64Array(this.resultBuffer.getMappedRange());this.rollingAverage.addSample(Number(r[1]-r[0])),this.resultBuffer.unmap(),this.onUpdate(this.rollingAverage.average)})},d.modifiedDevices.add(e)}}get time(){return this.rollingAverage.average}beginComputePass(e,t){const s={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1},i=e.beginComputePass({...t,...this.canTimestamp?{timestampWrites:s}:void 0}),r=i.end.bind(i);return i.end=()=>{r(),this.canTimestamp&&(e.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),this.resultBuffer.mapState==="unmapped"&&e.copyBufferToBuffer(this.resolveBuffer,this.resultBuffer))},i}reset(){this.rollingAverage.reset()}}function p(n){return`/Procedural-Snowflakes/${n}`}function g(n){return n+16-n%16}class l{shader;constructor(e,t,s){this.shader=e.createShaderModule({label:s,code:t})}static async fetch(e,t,s){const i=await(await fetch(t)).text(),r=await l.preprocess(t,i);return new l(e,r,s)}static async preprocess(e,t){return l.resolveImports(e,t)}static async resolveImports(e,t,s=[]){const i=/#!import.*\s/g,r=e.split("/"),o=r.slice(0,r.length-1).join("/")+"/",c=t.match(i)?.map(a=>a.replaceAll(/(#!import)|\s/g,"")).filter(a=>!s.includes(a)).map(a=>o+a+".wgsl")??[];return((await Promise.all(c.map(async a=>{const h=await(await fetch(a)).text();return l.resolveImports(a,h,s)}))).join("")+t).replaceAll(i,"")}}class u{static RENDER_SETTINGS_BYTE_LENGTH=g(1*Float32Array.BYTES_PER_ELEMENT);static COMPUTE_SETTINGS_BYTE_LENGTH=g(1*Float32Array.BYTES_PER_ELEMENT);canvas;settings;device;ctx;canvasFormat;gpuTimer;initialised;renderSettingsBuffer;renderBindGroupLayout;renderBindGroup;renderPipeline;renderTexture;sampler;computeSettingsBuffer;computeBindGroupLayout;computeBindGroup;computePipeline;constructor(e,t,s){const i=e.getContext("webgpu");if(i===null)throw new Error("Could not create WebGPU Canvas Context");this.canvas=e,this.device=s,this.ctx=i,this.canvasFormat="rgba8unorm",this.gpuTimer=new d(this.device,r=>{const o=r/1e3,c=r/1e6,f=r/1e9,a=c>1,h=(a?c:o).toFixed(2),T=a?"ms":"Î¼s";if(this.settings.timing?.frameTimeElement!==void 0&&(this.settings.timing.frameTimeElement.textContent=h+T),this.settings.timing?.fpsElement!==void 0){const B=1/f;this.settings.timing.fpsElement.textContent=B.toFixed(2)}}),this.initialised=!1,this.settings={timing:t.timing}}serialiseRenderSettings(){return new m(u.RENDER_SETTINGS_BYTE_LENGTH).buffer}serialiseComputeSettings(){return new m(u.COMPUTE_SETTINGS_BYTE_LENGTH).buffer}createRenderTexture(){return this.device.createTexture({label:"Render Texture",format:"rgba8unorm",size:[this.canvas.width,this.canvas.height],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT})}createRenderBindGroup(){return this.device.createBindGroup({label:"Renderer Bind Group",layout:this.renderBindGroupLayout,entries:[{binding:0,resource:{buffer:this.renderSettingsBuffer}},{binding:1,resource:this.renderTexture.createView()},{binding:2,resource:this.sampler}]})}createComputeBindGroup(){return this.device.createBindGroup({label:"Compute Bind Group",layout:this.computeBindGroupLayout,entries:[{binding:0,resource:{buffer:this.computeSettingsBuffer}},{binding:1,resource:this.renderTexture.createView()}]})}async initialise(){this.initialised||(await this.initialiseRendering(),await this.initialiseCompute(),this.updateSettings(),new ResizeObserver(e=>{const t=e[0],s=t.devicePixelContentBoxSize[0].inlineSize,i=t.devicePixelContentBoxSize[0].blockSize;this.canvas.width=s,this.canvas.height=i,this.renderTexture.destroy(),this.gpuTimer.reset(),this.renderTexture=this.createRenderTexture(),this.renderBindGroup=this.createRenderBindGroup(),this.computeBindGroup=this.createComputeBindGroup(),this.render()}).observe(this.canvas),this.initialised=!0)}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat}),this.renderSettingsBuffer=this.device.createBuffer({label:"Render Settings Buffer",size:u.RENDER_SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.renderTexture=this.createRenderTexture(),this.sampler=this.device.createSampler({label:"Renderer Texture Sampler",minFilter:"linear",magFilter:"linear"});const e=await l.fetch(this.device,p("shaders/render.wgsl"));this.renderBindGroupLayout=this.device.createBindGroupLayout({label:"Renderer Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,texture:{},visibility:GPUShaderStage.FRAGMENT},{binding:2,sampler:{},visibility:GPUShaderStage.FRAGMENT}]}),this.renderBindGroup=this.createRenderBindGroup();const t=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[this.renderBindGroupLayout]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:t,vertex:{module:e.shader,entryPoint:"vertexMain"},fragment:{module:e.shader,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]}})}async initialiseCompute(){this.computeSettingsBuffer=this.device.createBuffer({label:"Compute Settings Buffer",size:u.COMPUTE_SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM});const e=await l.fetch(this.device,p("shaders/compute.wgsl"));this.computeBindGroupLayout=this.device.createBindGroupLayout({label:"Compute Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"rgba8unorm"},visibility:GPUShaderStage.COMPUTE}]}),this.computeBindGroup=this.createComputeBindGroup();const t=this.device.createPipelineLayout({label:"Compute Pipeline Layout",bindGroupLayouts:[this.computeBindGroupLayout]});this.computePipeline=this.device.createComputePipeline({label:"Compute Pipeline",layout:t,compute:{module:e.shader,entryPoint:"main"}})}updateSettings(){this.device.queue.writeBuffer(this.renderSettingsBuffer,0,this.serialiseRenderSettings()),this.device.queue.writeBuffer(this.computeSettingsBuffer,0,this.serialiseComputeSettings())}render(){this.compute(),this.renderToCanvas()}compute(){const e=this.device.createCommandEncoder(),t=this.gpuTimer.beginComputePass(e);t.setBindGroup(0,this.computeBindGroup),t.setPipeline(this.computePipeline),t.dispatchWorkgroups(Math.ceil(this.canvas.width/8),Math.ceil(this.canvas.height/8),1),t.end(),this.device.queue.submit([e.finish()])}renderToCanvas(){const e=this.device.createCommandEncoder(),t=e.beginRenderPass({colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}]});t.setBindGroup(0,this.renderBindGroup),t.setPipeline(this.renderPipeline),t.draw(3),t.end(),this.device.queue.submit([e.finish()])}static async create(e,t={}){if(!("gpu"in navigator))throw new Error("WebGPU not supported");const s=await navigator.gpu.requestAdapter();if(s===null)throw new Error("Could not find suitable GPU Adapter");const i=await s.requestDevice({requiredFeatures:["timestamp-query"]});if(i===null)throw new Error("Could not find suitable GPU Device");return new u(e,t,i)}}class E{settings;callbacks=[];frameID;lastFrameTime;totalTime;constructor(e={}){this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.callbacks=[],this.settings={wormholeThreshold:e.wormholeThreshold??500}}start(){this.running||(this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}restart(){this.running&&this.stop(),this.start()}addCallback(e){this.callbacks.push(e)}tick(e){this.lastFrameTime<0&&(this.lastFrameTime=e);const t=e-this.lastFrameTime,s=this.totalTime+t;if(t<this.settings.wormholeThreshold){const i={deltaTime:t,totalTime:s};for(const r of this.callbacks)r(i);this.totalTime=s}this.lastFrameTime=e,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return this.frameID!==null}}function y(){b()}function b(){const n=document.getElementById("chevron"),e=document.getElementById("content");if(n===null)throw new Error("Could not find chevron element");if(e===null)throw new Error("Could not find info panel");n.addEventListener("click",()=>{n.classList.toggle("collapsed"),e.classList.toggle("collapsed")})}async function P(){const n=document.getElementById("main"),e=document.getElementById("frameTime"),t=document.getElementById("fps"),s=await u.create(n,{timing:{frameTimeElement:e,fpsElement:t}});await s.initialise();const i=new E;y(),i.addCallback(()=>{s.render()}),i.start()}P().catch(n=>{const e=n instanceof Error?n.message:JSON.stringify(n),t=document.getElementById("alert");t!==null&&(t.style.zIndex="999",t.classList.add("error"),t.textContent=e),console.error(e)});
